{% extends 'base_new.html' %}

{% block title %}Mind Map - NeuralFlow{% endblock %}

{% block content %}
<section class="section" style="padding: 0; height: 100vh; overflow: hidden;">
    <div class="mindmap-container">
        <header class="mindmap-toolbar">
            <div class="toolbar-left">
                <a href="{% url 'project_boards' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Boards
                </a>
                <h1 id="boardTitle">Mind Map</h1>
            </div>
            <div class="toolbar-center">
                <input id="searchInput" type="text" placeholder="Search topics..." class="search-input">
                <span id="statsDisplay" class="stats-text">0 topics</span>
            </div>
            <div class="toolbar-right">
                <button id="addTopicBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Topic
                </button>
            </div>
        </header>
        
        <div id="mindmapStage" class="mindmap-stage">
            <div id="emptyState" class="empty-state">
                <div class="empty-panel">
                    <i class="fas fa-brain" style="font-size: 4rem; color: #5b8cff; margin-bottom: 1rem;"></i>
                    <h3>Create your first topic</h3>
                    <p>Start building your project mind map by adding a root topic</p>
                    <button id="emptyAddBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Topic
                    </button>
                </div>
            </div>
            <svg id="mindmapSvg"></svg>
        </div>
    </div>
</section>

<!-- Topic Editor Modal -->
<div id="topicEditor" class="modal-back" style="display: none;">
    <div class="modal">
        <div class="modal-head">
            <h3>Edit Topic</h3>
            <button class="x" id="editorClose">âœ•</button>
        </div>
        <div class="modal-body">
            <label class="field">
                <span>Title</span>
                <input id="editorTitle" type="text" placeholder="e.g., Project Architecture">
            </label>
            <label class="field">
                <span>Description</span>
                <textarea id="editorDesc" rows="3" placeholder="Detailed description..."></textarea>
            </label>
            <label class="field">
                <span>Priority</span>
                <div class="custom-select-wrapper">
                    <select id="editorPriority">
                        <option value="low">ðŸŸ¢ Low Priority</option>
                        <option value="medium" selected>ðŸŸ¡ Medium Priority</option>
                        <option value="high">ðŸ”´ High Priority</option>
                        <option value="critical">ðŸš¨ Critical Priority</option>
                    </select>
                    <div class="select-arrow">â–¼</div>
                </div>
            </label>
            <label class="field">
                <span>Status</span>
                <select id="editorStatus">
                    <option value="planning">Planning</option>
                    <option value="progress" selected>In Progress</option>
                    <option value="review">Review</option>
                    <option value="done">Done</option>
                </select>
            </label>
        </div>
        <div class="modal-foot">
            <button class="btn btn-secondary" id="editorCancel">Cancel</button>
            <button class="btn btn-primary" id="editorSave">Save</button>
        </div>
    </div>
</div>

<style>
.mindmap-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #070f1f;
    background:
        radial-gradient(1400px 700px at 10% -10%, #0f1a3a 0%, transparent 60%),
        radial-gradient(1200px 600px at 90% 0%, #081532 0%, transparent 60%),
        linear-gradient(#081226, #070f1f 60%, #070f1f);
    background-attachment: fixed, fixed, fixed;
}

.mindmap-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    background: rgba(10,17,32,.65);
    border-bottom: 1px solid rgba(91,140,255,.2);
    backdrop-filter: blur(20px);
    z-index: 10;
    box-shadow: 0 4px 20px rgba(0,0,0,.3);
}

.toolbar-left, .toolbar-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.toolbar-center {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.toolbar-left h1 {
    color: #e7ecf7;
    margin: 0;
    font-size: 1.5rem;
}

.search-input {
    padding: 8px 16px;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 20px;
    background: rgba(11,18,34,.8);
    color: #e7ecf7;
    width: 250px;
}

.search-input:focus {
    outline: none;
    border-color: #5b8cff;
    box-shadow: 0 0 0 2px rgba(91,140,255,.2);
}

.stats-text {
    color: #9fb0d9;
    font-size: 0.9rem;
}

.mindmap-stage {
    flex: 1;
    position: relative;
    overflow: hidden;
}

.empty-state {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 5;
}

.empty-panel {
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 22px;
    padding: 3rem;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.empty-panel h3 {
    color: #e7ecf7;
    margin-bottom: 1rem;
}

.empty-panel p {
    color: #9fb0d9;
    margin-bottom: 2rem;
}

#mindmapSvg {
    width: 100%;
    height: 100%;
    cursor: grab;
}

#mindmapSvg:active {
    cursor: grabbing;
}

#mindmapSvg.panning {
    cursor: grabbing;
}

.mindmap-node {
    cursor: pointer;
}

.node-card {
    fill: rgba(255,255,255,.06);
    stroke: #5b8cff;
    stroke-width: 2;
    rx: 16;
    ry: 16;
}

.node-card.status-done {
    fill: rgba(34,197,94,.2);
    stroke: #22c55e;
}

.node-card.status-progress {
    fill: rgba(245,158,11,.2);
    stroke: #f59e0b;
    stroke-dasharray: 5,5;
    animation: progressPulse 2s ease-in-out infinite;
}

.node-card.status-review {
    fill: rgba(91,140,255,.2);
    stroke: #5b8cff;
}

.node-card.status-planning {
    fill: rgba(91,140,255,.2);
    stroke: #5b8cff;
}

.node-card.priority-high {
    stroke: #ef4444;
    stroke-width: 3;
}

.node-card.priority-critical {
    stroke: #dc2626;
    stroke-width: 4;
    stroke-dasharray: 3,3;
    animation: criticalBlink 1s ease-in-out infinite;
}

@keyframes progressPulse {
    0%, 100% { stroke-opacity: 0.8; }
    50% { stroke-opacity: 1; }
}

@keyframes criticalBlink {
    0%, 100% { stroke-opacity: 0.7; }
    50% { stroke-opacity: 1; }
}

.status-indicator {
    r: 8;
    cursor: pointer;
}

.status-indicator.status-done {
    fill: #22c55e;
}

.status-indicator.status-progress {
    fill: #f59e0b;
}

.status-indicator.status-review {
    fill: #5b8cff;
}

.status-indicator.status-planning {
    fill: #5b8cff;
}

.node-due {
    fill: #f59e0b;
    font-size: 9px;
    text-anchor: middle;
    dominant-baseline: middle;
}

.node-due.overdue {
    fill: #ef4444;
    font-weight: bold;
    animation: overdueBlink 1.5s ease-in-out infinite;
}

@keyframes overdueBlink {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

.mindmap-link.status-done {
    stroke: #22c55e;
}

.mindmap-link.status-progress {
    stroke: #f59e0b;
}

.mindmap-link.status-review {
    stroke: #5b8cff;
}

.mindmap-link.status-planning {
    stroke: #5b8cff;
}

.node-title {
    fill: #e7ecf7;
    font-size: 18px;
    font-weight: 600;
    text-anchor: middle;
    dominant-baseline: middle;
}

.node-desc {
    fill: #9fb0d9;
    font-size: 11px;
    text-anchor: middle;
    dominant-baseline: middle;
}

.node-actions {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.mindmap-node:hover .node-actions {
    opacity: 1;
}

.action-btn {
    fill: rgba(91,140,255,.2);
    stroke: #5b8cff;
    stroke-width: 1;
    cursor: pointer;
}

.action-btn:hover {
    fill: rgba(91,140,255,.4);
}

.action-icon {
    fill: #5b8cff;
    font-size: 12px;
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
}

.mindmap-link {
    stroke: #5b8cff;
    stroke-width: 2;
    fill: none;
    opacity: 0.8;
}

.dragging {
    opacity: 0.8;
}

.dim {
    opacity: 0.3;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn-primary {
    background: linear-gradient(135deg, #5b8cff, #764ba2);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(91,140,255,.4);
}

.btn-secondary {
    background: rgba(255,255,255,.06);
    color: #5b8cff;
    border: 1px solid rgba(91,140,255,.3);
}

.btn-secondary:hover {
    background: rgba(91,140,255,.1);
    border-color: #5b8cff;
    transform: translateY(-2px);
}

.modal-back {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal {
    background: #0b1222;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(91,140,255,.3);
}

.modal-head h3 {
    color: #e7ecf7;
    margin: 0;
}

.modal-head .x {
    background: none;
    border: none;
    color: #9fb0d9;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.modal-head .x:hover {
    background: rgba(91,140,255,.1);
    color: #5b8cff;
}

.modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-foot {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1.5rem;
    border-top: 1px solid rgba(91,140,255,.3);
}

.field {
    display: block;
    margin-bottom: 1.5rem;
}

.field span {
    display: block;
    color: #e7ecf7;
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 14px;
    letter-spacing: 0.5px;
}

.field input, .field textarea, .field select {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 8px;
    background: rgba(255,255,255,.06);
    color: #e7ecf7;
    font-family: inherit;
    font-size: 14px;
}

.field select {
    background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%235b8cff" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 12px;
    padding-right: 40px;
    appearance: none;
    cursor: pointer;
}

.field select option {
    background: #0b1222;
    color: #e7ecf7;
    padding: 8px 12px;
}

.field input:focus, .field textarea:focus, .field select:focus {
    outline: none;
    border-color: #5b8cff;
    box-shadow: 0 0 0 2px rgba(91,140,255,.2);
    background: rgba(255,255,255,.08);
}

.field select:hover {
    background-color: rgba(255,255,255,.08);
    border-color: #5b8cff;
}

.field textarea {
    resize: vertical;
    min-height: 80px;
}

.field input::placeholder, .field textarea::placeholder {
    color: #9fb0d9;
    opacity: 0.7;
}

.custom-select-wrapper {
    position: relative;
}

.custom-select-wrapper select {
    appearance: none;
    background: rgba(255,255,255,.08) !important;
    padding-right: 40px;
    cursor: pointer;
}

.custom-select-wrapper select option {
    background: #0b1222;
    color: #e7ecf7;
    padding: 8px 12px;
}

.custom-select-wrapper .select-arrow {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9fb0d9;
    pointer-events: none;
    font-size: 0.8rem;
}

.custom-select-wrapper select:focus + .select-arrow {
    color: #5b8cff;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentBoard = JSON.parse(sessionStorage.getItem('current_board') || '{}');
    document.getElementById('boardTitle').textContent = currentBoard.name || 'Mind Map';
    
    const svg = document.getElementById('mindmapSvg');
    const stage = document.getElementById('mindmapStage');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const statsDisplay = document.getElementById('statsDisplay');
    const addTopicBtn = document.getElementById('addTopicBtn');
    const emptyAddBtn = document.getElementById('emptyAddBtn');
    
    const editor = document.getElementById('topicEditor');
    const editorClose = document.getElementById('editorClose');
    const editorCancel = document.getElementById('editorCancel');
    const editorSave = document.getElementById('editorSave');
    const editorTitle = document.getElementById('editorTitle');
    const editorDesc = document.getElementById('editorDesc');
    const editorPriority = document.getElementById('editorPriority');
    const editorStatus = document.getElementById('editorStatus');
    
    let editingNodeId = null;
    let isDragging = false;
    let dragNode = null;
    let dragOffset = { x: 0, y: 0 };
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let viewBox = { x: 0, y: 0, width: 0, height: 0 };
    let scale = 1;
    
    const STORAGE_KEY = `neuralflow_mindmap_${currentBoard.id || 'default'}`;
    let mindmapData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"nodes": [], "links": []}');
    
    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(mindmapData));
        updateStats();
    }
    
    function updateStats() {
        statsDisplay.textContent = `${mindmapData.nodes.length} topics`;
        emptyState.style.display = mindmapData.nodes.length === 0 ? 'block' : 'none';
    }
    
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    function addNode(parentId = null) {
        const newNode = {
            id: generateId(),
            title: '',
            desc: '',
            priority: 'medium',
            status: 'planning',
            due: '',
            x: stage.clientWidth / 2 + (Math.random() - 0.5) * 200,
            y: stage.clientHeight / 2 + (Math.random() - 0.5) * 200
        };
        
        mindmapData.nodes.push(newNode);
        
        if (parentId) {
            mindmapData.links.push({
                source: parentId,
                target: newNode.id
            });
        }
        
        saveData();
        render();
        openEditor(newNode.id);
    }
    
    function deleteNode(nodeId) {
        const toDelete = new Set([nodeId]);
        
        function findChildren(parentId) {
            mindmapData.links.forEach(link => {
                if (link.source === parentId && !toDelete.has(link.target)) {
                    toDelete.add(link.target);
                    findChildren(link.target);
                }
            });
        }
        
        findChildren(nodeId);
        
        mindmapData.nodes = mindmapData.nodes.filter(n => !toDelete.has(n.id));
        mindmapData.links = mindmapData.links.filter(l => !toDelete.has(l.source) && !toDelete.has(l.target));
        
        saveData();
        render();
    }
    
    function updateNode(nodeId, data) {
        const node = mindmapData.nodes.find(n => n.id === nodeId);
        if (node) {
            Object.assign(node, data);
            saveData();
            render();
        }
    }
    
    function openEditor(nodeId) {
        const node = mindmapData.nodes.find(n => n.id === nodeId);
        if (!node) return;
        
        editingNodeId = nodeId;
        editorTitle.value = node.title || '';
        editorDesc.value = node.desc || '';
        editorPriority.value = node.priority || 'medium';
        editorStatus.value = node.status || 'planning';
        
        editor.style.display = 'flex';
        editorTitle.focus();
    }
    
    function closeEditor() {
        editor.style.display = 'none';
        editingNodeId = null;
    }
    
    function saveEditor() {
        if (!editingNodeId) return;
        
        const title = editorTitle.value.trim() || 'Untitled Topic';
        const desc = editorDesc.value.trim();
        const priority = editorPriority.value;
        const status = editorStatus.value;
        
        updateNode(editingNodeId, { title, desc, priority, status });
        closeEditor();
    }
    
    function render() {
        svg.innerHTML = '';
        
        if (mindmapData.nodes.length === 0) {
            updateStats();
            return;
        }
        
        const width = stage.clientWidth;
        const height = stage.clientHeight;
        
        // Initialize viewBox if not set
        if (viewBox.width === 0) {
            viewBox = { x: 0, y: 0, width: width, height: height };
            svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
        }
        
        mindmapData.nodes.forEach(node => {
            if (node.x === undefined) node.x = width / 2 + (Math.random() - 0.5) * 200;
            if (node.y === undefined) node.y = height / 2 + (Math.random() - 0.5) * 200;
        });
        
        // Render links with status-based coloring
        mindmapData.links.forEach(link => {
            const source = mindmapData.nodes.find(n => n.id === link.source);
            const target = mindmapData.nodes.find(n => n.id === link.target);
            if (!source || !target) return;
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const dx = target.x - source.x;
            const dy = target.y - source.y;
            const dr = Math.sqrt(dx * dx + dy * dy) * 0.3;
            path.setAttribute('d', `M${source.x},${source.y}A${dr},${dr} 0 0,1 ${target.x},${target.y}`);
            path.setAttribute('class', `mindmap-link status-${target.status}`);
            path.setAttribute('data-source', link.source);
            path.setAttribute('data-target', link.target);
            svg.appendChild(path);
        });
        
        // Render nodes
        mindmapData.nodes.forEach(node => {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('class', 'mindmap-node');
            g.setAttribute('transform', `translate(${node.x},${node.y})`);
            g.setAttribute('data-id', node.id);
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('class', `node-card status-${node.status} priority-${node.priority}`);
            rect.setAttribute('width', '240');
            rect.setAttribute('height', '120');
            rect.setAttribute('x', '-120');
            rect.setAttribute('y', '-60');
            g.appendChild(rect);
            
            // Priority emoji in bottom right corner
            const priorityEmoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            priorityEmoji.setAttribute('class', 'priority-emoji');
            priorityEmoji.setAttribute('x', '100');
            priorityEmoji.setAttribute('y', '45');
            priorityEmoji.setAttribute('font-size', '16px');
            priorityEmoji.setAttribute('text-anchor', 'middle');
            const priorityEmojis = { low: 'ðŸŸ¢', medium: 'ðŸŸ¡', high: 'ðŸ”´', critical: 'ðŸš¨' };
            priorityEmoji.textContent = priorityEmojis[node.priority] || 'ðŸŸ¡';
            g.appendChild(priorityEmoji);
            
            // Status indicator circle
            const statusCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            statusCircle.setAttribute('class', `status-indicator status-${node.status}`);
            statusCircle.setAttribute('cx', '-100');
            statusCircle.setAttribute('cy', '40');
            statusCircle.addEventListener('click', (e) => {
                e.stopPropagation();
                const currentStatus = node.status;
                const newStatus = currentStatus === 'done' ? 'planning' : 'done';
                updateNode(node.id, { status: newStatus });
            });
            g.appendChild(statusCircle);
            
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('class', 'node-title');
            title.setAttribute('y', '-30');
            title.setAttribute('x', '0');
            title.setAttribute('text-anchor', 'middle');
            title.textContent = node.title || 'Untitled Topic';
            g.appendChild(title);
            
            const desc = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            desc.setAttribute('class', 'node-desc');
            desc.setAttribute('y', '-5');
            desc.setAttribute('x', '-110');
            desc.setAttribute('text-anchor', 'start');
            desc.textContent = node.desc ? (node.desc.length > 35 ? node.desc.substring(0, 35) + '...' : node.desc) : '';
            g.appendChild(desc);
            
            // Due date
            const dueDate = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            const today = new Date().toISOString().split('T')[0];
            const isOverdue = node.due && node.due < today;
            dueDate.setAttribute('class', isOverdue ? 'node-due overdue' : 'node-due');
            dueDate.setAttribute('y', '20');
            dueDate.setAttribute('x', '-110');
            dueDate.setAttribute('text-anchor', 'start');
            if (node.due) {
                dueDate.textContent = isOverdue ? `âš ï¸ Overdue: ${node.due}` : `ðŸ“… Due: ${node.due}`;
            }
            g.appendChild(dueDate);
            
            const actions = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            actions.setAttribute('class', 'node-actions');
            
            // Add button - positioned inside card top right
            const addBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            addBtn.setAttribute('transform', 'translate(90, -40)');
            addBtn.style.cursor = 'pointer';
            const addCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            addCircle.setAttribute('class', 'action-btn');
            addCircle.setAttribute('r', '12');
            const addText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            addText.setAttribute('class', 'action-icon');
            addText.textContent = '+';
            addBtn.appendChild(addCircle);
            addBtn.appendChild(addText);
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                addNode(node.id);
            });
            
            // Edit button - positioned inside card middle right
            const editBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            editBtn.setAttribute('transform', 'translate(90, -10)');
            editBtn.style.cursor = 'pointer';
            const editCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            editCircle.setAttribute('class', 'action-btn');
            editCircle.setAttribute('r', '12');
            const editText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            editText.setAttribute('class', 'action-icon');
            editText.textContent = 'âœŽ';
            editBtn.appendChild(editCircle);
            editBtn.appendChild(editText);
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditor(node.id);
            });
            
            // Delete button - positioned inside card bottom right (above emoji)
            const delBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            delBtn.setAttribute('transform', 'translate(90, 20)');
            delBtn.style.cursor = 'pointer';
            const delCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            delCircle.setAttribute('class', 'action-btn');
            delCircle.setAttribute('r', '12');
            const delText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            delText.setAttribute('class', 'action-icon');
            delText.textContent = 'ðŸ—‘';
            delBtn.appendChild(delCircle);
            delBtn.appendChild(delText);
            delBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteNode(node.id);
            });
            
            actions.appendChild(addBtn);
            actions.appendChild(editBtn);
            actions.appendChild(delBtn);
            g.appendChild(actions);
            
            // Drag handlers - only on card background, not action buttons
            rect.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragNode = node;
                const svgRect = svg.getBoundingClientRect();
                const svgX = (e.clientX - svgRect.left) / scale + viewBox.x;
                const svgY = (e.clientY - svgRect.top) / scale + viewBox.y;
                dragOffset.x = svgX - node.x;
                dragOffset.y = svgY - node.y;
                g.classList.add('dragging');
                e.preventDefault();
                e.stopPropagation();
            });
            
            title.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragNode = node;
                const svgRect = svg.getBoundingClientRect();
                const svgX = (e.clientX - svgRect.left) / scale + viewBox.x;
                const svgY = (e.clientY - svgRect.top) / scale + viewBox.y;
                dragOffset.x = svgX - node.x;
                dragOffset.y = svgY - node.y;
                g.classList.add('dragging');
                e.preventDefault();
                e.stopPropagation();
            });
            
            title.addEventListener('dblclick', () => openEditor(node.id));
            
            svg.appendChild(g);
        });
        
        updateStats();
    }
    
    // Pan and zoom functionality
    svg.addEventListener('mousedown', (e) => {
        if (e.target === svg) {
            isPanning = true;
            panStart.x = e.clientX;
            panStart.y = e.clientY;
            svg.classList.add('panning');
            e.preventDefault();
        }
    });
    
    svg.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 1.1 : 0.9;
        scale *= delta;
        scale = Math.max(0.1, Math.min(5, scale));
        
        const rect = svg.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const newWidth = stage.clientWidth / scale;
        const newHeight = stage.clientHeight / scale;
        
        viewBox.x += (mouseX / stage.clientWidth) * (viewBox.width - newWidth);
        viewBox.y += (mouseY / stage.clientHeight) * (viewBox.height - newHeight);
        viewBox.width = newWidth;
        viewBox.height = newHeight;
        
        svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
    });
    
    // Global mouse handlers for dragging and panning
    document.addEventListener('mousemove', (e) => {
        if (isPanning) {
            const dx = (panStart.x - e.clientX) / scale;
            const dy = (panStart.y - e.clientY) / scale;
            viewBox.x += dx;
            viewBox.y += dy;
            panStart.x = e.clientX;
            panStart.y = e.clientY;
            svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
            return;
        }
        
        if (!isDragging || !dragNode) return;
        
        const rect = svg.getBoundingClientRect();
        const svgX = (e.clientX - rect.left) / scale + viewBox.x;
        const svgY = (e.clientY - rect.top) / scale + viewBox.y;
        
        dragNode.x = svgX - dragOffset.x;
        dragNode.y = svgY - dragOffset.y;
        
        // Update node position
        const nodeEl = svg.querySelector(`[data-id="${dragNode.id}"]`);
        if (nodeEl) {
            nodeEl.setAttribute('transform', `translate(${dragNode.x},${dragNode.y})`);
        }
        
        // Update all links connected to this node
        svg.querySelectorAll('.mindmap-link').forEach(link => {
            const sourceId = link.getAttribute('data-source');
            const targetId = link.getAttribute('data-target');
            
            if (sourceId === dragNode.id || targetId === dragNode.id) {
                const source = mindmapData.nodes.find(n => n.id === sourceId);
                const target = mindmapData.nodes.find(n => n.id === targetId);
                if (source && target) {
                    const dx = target.x - source.x;
                    const dy = target.y - source.y;
                    const dr = Math.sqrt(dx * dx + dy * dy) * 0.3;
                    link.setAttribute('d', `M${source.x},${source.y}A${dr},${dr} 0 0,1 ${target.x},${target.y}`);
                }
            }
        });
    });
    
    document.addEventListener('mouseup', () => {
        if (isPanning) {
            isPanning = false;
            svg.classList.remove('panning');
        }
        if (isDragging) {
            isDragging = false;
            if (dragNode) {
                const nodeEl = svg.querySelector(`[data-id="${dragNode.id}"]`);
                if (nodeEl) nodeEl.classList.remove('dragging');
                saveData();
            }
            dragNode = null;
        }
    });
    
    // Event listeners
    addTopicBtn.addEventListener('click', () => addNode());
    emptyAddBtn.addEventListener('click', () => addNode());
    editorClose.addEventListener('click', closeEditor);
    editorCancel.addEventListener('click', closeEditor);
    editorSave.addEventListener('click', saveEditor);
    editor.addEventListener('click', (e) => {
        if (e.target === editor) closeEditor();
    });
    
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase().trim();
        svg.querySelectorAll('.mindmap-node').forEach(node => {
            const nodeData = mindmapData.nodes.find(n => n.id === node.getAttribute('data-id'));
            if (!nodeData) return;
            
            const matches = !query || 
                nodeData.title.toLowerCase().includes(query) || 
                nodeData.desc.toLowerCase().includes(query);
            
            node.classList.toggle('dim', !matches);
        });
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && editor.style.display === 'flex') {
            closeEditor();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && editor.style.display === 'flex') {
            saveEditor();
        }
    });
    
    window.addEventListener('resize', () => {
        setTimeout(render, 100);
    });
    
    render();
});
</script>
{% endblock %}