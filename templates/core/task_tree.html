{% extends 'base_new.html' %}

{% block title %}Task Tree - WorkFlowAI{% endblock %}

{% block content %}
{% csrf_token %}
<section class="section" style="padding: 0; height: 100vh; overflow: hidden;">
    <div class="tree-container">
        <header class="tree-toolbar">
            <div class="toolbar-left">
                <a href="{% url 'project_boards' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Boards
                </a>
                <h1 id="boardTitle">Task Tree</h1>
            </div>
            <div class="toolbar-center">
                <input id="searchInput" type="text" placeholder="Search tasks..." class="search-input">
                <span id="statsDisplay" class="stats-text">0 tasks</span>
            </div>
            <div class="toolbar-right">
                <div class="layout-selector">
                    <label><input type="radio" name="layout" value="tree" checked> Tree</label>
                    <label><input type="radio" name="layout" value="cluster"> Cluster</label>
                    <label><input type="radio" name="layout" value="radial"> Radial</label>
                </div>
                <button id="addRootBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Root Task
                </button>
            </div>
        </header>
        
        <div id="treeStage" class="tree-stage">
            <div id="emptyState" class="empty-state">
                <div class="empty-panel">
                    <i class="fas fa-sitemap" style="font-size: 4rem; color: #22c55e; margin-bottom: 1rem;"></i>
                    <h3>Create your first task</h3>
                    <p>Build a hierarchical structure for your project tasks</p>
                    <button id="emptyAddBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Root Task
                    </button>
                </div>
            </div>
            <svg id="treeSvg"></svg>
        </div>
    </div>
</section>

<!-- Calendar Modal -->
<div class="modal-back" id="dateModal" style="display: none;">
    <div class="modal">
        <div class="cal-head">
            <button class="btn small" id="prevM">‚Üê</button>
            <div id="calTitle"></div>
            <button class="btn small" id="nextM">‚Üí</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="cal-foot">
            <button class="btn small" id="okBtn">Set</button>
            <button class="btn small" id="cancelBtn">Cancel</button>
        </div>
    </div>
</div>

<!-- Task Editor Modal -->
<div id="taskEditor" class="modal-back" style="display: none;">
    <div class="modal">
        <div class="modal-head">
            <h3>Edit Task</h3>
            <button class="x" id="editorClose">‚úï</button>
        </div>
        <div class="modal-body">
            <label class="field">
                <span>Task Title</span>
                <input id="editorTitle" type="text" placeholder="e.g., Project Setup">
            </label>
            <label class="field">
                <span>Description</span>
                <textarea id="editorDesc" rows="3" placeholder="Task details and requirements..."></textarea>
            </label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <label class="field">
                    <span>Start Date</span>
                    <div class="fake-date" id="editorStartDate" data-value="">
                        <span id="startDateLabel">üìÖ Pick start date‚Ä¶</span><span class="muted">‚ñæ</span>
                    </div>
                </label>
                <label class="field">
                    <span>End Date</span>
                    <div class="fake-date" id="editorEndDate" data-value="">
                        <span id="endDateLabel">üìÖ Pick end date‚Ä¶</span><span class="muted">‚ñæ</span>
                    </div>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <label class="field">
                    <span>Email</span>
                    <input id="editorEmail" type="email" placeholder="contact@example.com">
                </label>
                <label class="field">
                    <span>Phone</span>
                    <input id="editorPhone" type="tel" placeholder="+1 234 567 8900">
                </label>
            </div>
            <label class="field">
                <span>Responsibility</span>
                <input id="editorResponsibility" type="text" placeholder="Person responsible for this task">
            </label>
            <label class="field">
                <span>Priority</span>
                <div class="custom-select-wrapper">
                    <select id="editorPriority">
                        <option value="low">üü¢ Low Priority</option>
                        <option value="medium" selected>üü° Medium Priority</option>
                        <option value="high">üî¥ High Priority</option>
                        <option value="critical">üö® Critical Priority</option>
                    </select>
                    <div class="select-arrow">‚ñº</div>
                </div>
            </label>
            <label class="field">
                <span>Status</span>
                <div class="custom-select-wrapper">
                    <select id="editorStatus">
                        <option value="todo">üìã To Do</option>
                        <option value="progress" selected>‚ö° In Progress</option>
                        <option value="review">üëÄ Review</option>
                        <option value="done">‚úÖ Done</option>
                    </select>
                    <div class="select-arrow">‚ñº</div>
                </div>
            </label>
        </div>
        <div class="modal-foot">
            <button class="btn btn-secondary" id="editorCancel">Cancel</button>
            <button class="btn btn-primary" id="editorSave">Save</button>
        </div>
    </div>
</div>



<style>
html, body {
    overflow: hidden !important;
    height: 100vh;
}

.tree-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #070f1f;
    background:
        radial-gradient(1400px 700px at 10% -10%, #0f1a3a 0%, transparent 60%),
        radial-gradient(1200px 600px at 90% 0%, #081532 0%, transparent 60%),
        linear-gradient(#081226, #070f1f 60%, #070f1f);
    background-attachment: fixed, fixed, fixed;
    overflow: hidden;
}

.tree-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    background: rgba(10,17,32,.65);
    border-bottom: 1px solid rgba(91,140,255,.2);
    backdrop-filter: blur(20px);
    z-index: 10;
    box-shadow: 0 4px 20px rgba(0,0,0,.3);
}

.toolbar-left, .toolbar-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.toolbar-center {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.toolbar-left h1 {
    color: #e7ecf7;
    margin: 0;
    font-size: 1.5rem;
}

.search-input {
    padding: 8px 16px;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 20px;
    background: rgba(11,18,34,.8);
    color: #e7ecf7;
    width: 250px;
}

.search-input:focus {
    outline: none;
    border-color: #5b8cff;
    box-shadow: 0 0 0 2px rgba(91,140,255,.2);
}

.stats-text {
    color: #9fb0d9;
    font-size: 0.9rem;
}

.layout-selector {
    display: flex;
    gap: 1rem;
    background: rgba(91,140,255,.1);
    padding: 8px 12px;
    border-radius: 20px;
    border: 1px solid rgba(91,140,255,.3);
}

.layout-selector label {
    color: #9fb0d9;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.layout-selector input[type="radio"] {
    margin: 0;
}

.layout-selector label:has(input:checked) {
    color: #5b8cff;
}

.tree-stage {
    flex: 1;
    position: relative;
    overflow: hidden;
    height: calc(100vh - 80px);
    max-height: calc(100vh - 80px);
}

.empty-state {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 5;
}

.empty-panel {
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 22px;
    padding: 3rem;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.empty-panel h3 {
    color: #e7ecf7;
    margin-bottom: 1rem;
}

.empty-panel p {
    color: #9fb0d9;
    margin-bottom: 2rem;
}

#treeSvg {
    width: 100%;
    height: 100%;
    cursor: grab;
    overflow: hidden;
}

#treeSvg:active {
    cursor: grabbing;
}

/* Tree node styles */
.tree-node {
    cursor: pointer;
}

.task-card {
    fill: rgba(255,255,255,.06);
    stroke: #5b8cff;
    stroke-width: 2;
    rx: 12;
    ry: 12;
}

.task-card.status-done {
    fill: rgba(34,197,94,.2);
    stroke: #22c55e;
}

.task-card.status-progress {
    fill: rgba(245,158,11,.2);
    stroke: #f59e0b;
    stroke-dasharray: 5,5;
    animation: progressPulse 2s ease-in-out infinite;
}

@keyframes progressPulse {
    0%, 100% { stroke-opacity: 0.8; }
    50% { stroke-opacity: 1; }
}

.task-card.status-review {
    fill: rgba(91,140,255,.2);
    stroke: #5b8cff;
}

.task-card.status-todo {
    fill: rgba(107,114,128,.2);
    stroke: #6b7280;
}

.status-indicator {
    r: 8;
}

.status-indicator.status-done {
    fill: #22c55e;
}

.status-indicator.status-progress {
    fill: #f59e0b;
}

.status-indicator.status-review {
    fill: #5b8cff;
}

.status-indicator.status-todo {
    fill: #6b7280;
}

.task-card.priority-high {
    stroke: #ef4444;
    stroke-width: 3;
}

.task-card.priority-critical {
    stroke: #dc2626;
    stroke-width: 4;
    stroke-dasharray: 3,3;
    animation: criticalBlink 1s ease-in-out infinite;
}

@keyframes criticalBlink {
    0%, 100% { stroke-opacity: 0.7; }
    50% { stroke-opacity: 1; }
}

.task-title {
    fill: #e7ecf7;
    font-size: 12px;
    font-weight: 600;
    text-anchor: start;
    dominant-baseline: middle;
}

.task-desc {
    fill: #9fb0d9;
    font-size: 10px;
    text-anchor: start;
    dominant-baseline: middle;
}

.task-due {
    fill: #f59e0b;
    font-size: 9px;
    text-anchor: start;
    dominant-baseline: middle;
}

.task-due.overdue {
    fill: #ef4444;
    font-weight: bold;
    animation: overdueBlink 1.5s ease-in-out infinite;
}

@keyframes overdueBlink {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

.add-btn:hover, .edit-btn:hover, .delete-btn:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

.tree-link {
    stroke-width: 2;
    fill: none;
}

.tree-link.status-done {
    stroke: #22c55e;
}

.tree-link.status-progress {
    stroke: #f59e0b;
}

.tree-link.status-review {
    stroke: #5b8cff;
}

.tree-link.status-todo {
    stroke: #6b7280;
}

.tree-link.collapsed {
    stroke-dasharray: 8,4;
    opacity: 0.6;
}

.collapse-btn {
    fill: #22c55e;
    stroke: #16a34a;
    stroke-width: 2;
    cursor: pointer;
}

.collapse-btn:hover {
    fill: #16a34a;
    transform: scale(1.1);
}

.collapse-btn {
    transition: all 0.2s ease;
}



.btn.small {
    padding: 6px 12px;
    font-size: 0.8rem;
}

.collapse-text {
    fill: white;
    font-size: 12px;
    font-weight: bold;
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
}

.dragging {
    opacity: 0.8;
}

.dim {
    opacity: 0.3;
}

/* Button Styles */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn-primary {
    background: linear-gradient(135deg, #5b8cff, #764ba2);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(91,140,255,.4);
}

.btn-secondary {
    background: rgba(255,255,255,.06);
    color: #5b8cff;
    border: 1px solid rgba(91,140,255,.3);
}

.btn-secondary:hover {
    background: rgba(91,140,255,.1);
    border-color: #5b8cff;
    transform: translateY(-2px);
}

/* Modal Styles */
.modal-back {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal {
    background: #0b1222;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(91,140,255,.3);
}

.modal-head h3 {
    color: #e7ecf7;
    margin: 0;
}

.modal-head .x {
    background: none;
    border: none;
    color: #9fb0d9;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.modal-head .x:hover {
    background: rgba(91,140,255,.1);
    color: #5b8cff;
}

.modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-foot {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1.5rem;
    border-top: 1px solid rgba(91,140,255,.3);
}

.field {
    display: block;
    margin-bottom: 1.5rem;
}

.field span {
    display: block;
    color: #e7ecf7;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.field input, .field textarea, .field select {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 8px;
    background: rgba(255,255,255,.06);
    color: #e7ecf7;
    font-family: inherit;
}

.field select option {
    background: #0b1222;
    color: #e7ecf7;
    padding: 8px 12px;
}

.field input:focus, .field textarea:focus, .field select:focus {
    outline: none;
    border-color: #5b8cff;
    box-shadow: 0 0 0 2px rgba(91,140,255,.2);
}

.custom-select-wrapper {
    position: relative;
}

.custom-select-wrapper select {
    appearance: none;
    background: rgba(255,255,255,.08);
    padding-right: 40px;
    cursor: pointer;
}

.custom-select-wrapper select option {
    background: #0b1222;
    color: #e7ecf7;
    padding: 8px 12px;
}

.custom-select-wrapper .select-arrow {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9fb0d9;
    pointer-events: none;
    font-size: 0.8rem;
}

.custom-select-wrapper select:focus + .select-arrow {
    color: #5b8cff;
}

.fake-date {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 8px;
    background: rgba(255,255,255,.06);
    color: #e7ecf7;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.3s ease;
}

.fake-date:hover {
    background: rgba(255,255,255,.08);
    border-color: #5b8cff;
}

.muted {
    color: #9fb0d9;
}

.cal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(91,140,255,.1);
    color: #e7ecf7;
    font-weight: 600;
}

.cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: rgba(91,140,255,.1);
    padding: 1px;
}

.cal-wd, .cal-day {
    padding: 8px;
    text-align: center;
    background: #0b1222;
    color: #e7ecf7;
}

.cal-wd {
    font-weight: 600;
    color: #9fb0d9;
    font-size: 0.8rem;
}

.cal-day {
    cursor: pointer;
    transition: all 0.3s ease;
}

.cal-day:hover {
    background: rgba(91,140,255,.2);
}

.cal-day.sel {
    background: #5b8cff;
    color: white;
}

.cal-day.out {
    opacity: 0.3;
    cursor: default;
}

.cal-foot {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    padding: 1rem;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get current board from session storage
    const currentBoard = JSON.parse(sessionStorage.getItem('current_board') || '{}');
    document.getElementById('boardTitle').textContent = currentBoard.name || 'Task Tree';
    
    const svg = d3.select('#treeSvg');
    const stage = document.getElementById('treeStage');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const statsDisplay = document.getElementById('statsDisplay');
    const addRootBtn = document.getElementById('addRootBtn');
    const emptyAddBtn = document.getElementById('emptyAddBtn');
    
    // Editor elements
    const editor = document.getElementById('taskEditor');
    const editorClose = document.getElementById('editorClose');
    const editorCancel = document.getElementById('editorCancel');
    const editorSave = document.getElementById('editorSave');
    const editorTitle = document.getElementById('editorTitle');
    const editorDesc = document.getElementById('editorDesc');
    const editorDue = document.getElementById('editorDue');
    const dueDateLabel = document.getElementById('dueDateLabel');
    const dateModal = document.getElementById('dateModal');
    const calGrid = document.getElementById('calGrid');
    const calTitle = document.getElementById('calTitle');
    
    let selectedDate = null;
    let viewYear = new Date().getFullYear();
    let viewMonth = new Date().getMonth();
    const weekdays = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];
    

    const editorPriority = document.getElementById('editorPriority');
    const editorStatus = document.getElementById('editorStatus');
    
    let editingNodeId = null;
    let pendingParentId = null;
    let currentLayout = 'tree';
    
    // Data management - use board storage
    const boardId = currentBoard.id || 'default';
    let treeData = { nodes: [] };
    
    function loadBoardTasks() {
        if (boardId !== 'default') {
            fetch(`/api/boards/${boardId}/tasks/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        treeData.nodes = convertTasksToNodes(data.tasks);
                        buildVisualization();
                    }
                })
                .catch(console.error);
        }
    }
    
    // Load board tasks on init
    loadBoardTasks();
    
    // Ensure nodes have required properties
    treeData.nodes.forEach(node => {
        node.children = node.children || [];
        node.collapsed = node.collapsed || false;
    });
    
    function saveData() {
        // Save to board storage instead of localStorage
        updateStats();
    }
    
    function convertTasksToNodes(tasks) {
        // Convert board tasks to hierarchical tree structure
        const taskMap = new Map();
        const rootNodes = [];
        
        // First pass: create all nodes
        tasks.forEach(task => {
            const node = {
                id: task.id,
                title: task.title || 'Untitled Task',
                desc: task.description || '',
                due: task.due_date || '',
                priority: task.priority || 'medium',
                status: task.status?.toLowerCase().replace(' ', '') || 'todo',
                children: [],
                collapsed: false,
                task_number: task.task_number || '1',
                parent_id: task.parent_id || null
            };
            taskMap.set(task.id, node);
        });
        
        // Second pass: build hierarchy
        taskMap.forEach(node => {
            if (node.parent_id && taskMap.has(node.parent_id)) {
                const parent = taskMap.get(node.parent_id);
                parent.children.push(node);
            } else {
                rootNodes.push(node);
            }
        });
        
        return rootNodes;
    }
    
    function updateStats() {
        const totalTasks = countAllNodes(treeData.nodes);
        statsDisplay.textContent = `${totalTasks} tasks`;
        
        if (treeData.nodes.length === 0) {
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
        }
    }
    
    function countAllNodes(nodes) {
        let count = nodes.length;
        nodes.forEach(node => {
            if (node.children) {
                count += countAllNodes(node.children);
            }
        });
        return count;
    }
    
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    // Node management
    function addRootTask() {
        openEditor(null);
    }
    
    function addChildTask(parentId) {
        pendingParentId = parentId;
        openEditor(null);
    }
    
    function createChildTask() {
        const title = editorTitle.value.trim() || 'Untitled Task';
        const description = editorDesc.value.trim();
        const startDate = document.getElementById('editorStartDate').dataset.value;
        const endDate = document.getElementById('editorEndDate').dataset.value;
        const email = document.getElementById('editorEmail').value.trim();
        const phone = document.getElementById('editorPhone').value.trim();
        const responsibility = document.getElementById('editorResponsibility').value.trim();
        const priority = editorPriority.value;
        const status = editorStatus.value;
        
        const taskData = {
            title,
            description,
            start_date: startDate,
            end_date: endDate,
            email,
            phone,
            responsibility,
            priority,
            status,
            board_id: boardId,
            parent_id: pendingParentId
        };
        
        fetch('/api/boards/tasks/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadBoardTasks();
                closeEditor();
            } else {
                console.error('Failed to create task:', data.error);
            }
        })
        .catch(console.error);
    }
    
    function deleteTask(nodeId) {
        fetch(`/api/boards/${boardId}/tasks/${nodeId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadBoardTasks();
            }
        })
        .catch(console.error);
    }
    
    function findNode(nodes, id) {
        for (const node of nodes) {
            if (node.id === id) return node;
            if (node.children) {
                const found = findNode(node.children, id);
                if (found) return found;
            }
        }
        return null;
    }
    
    function removeNodeFromTree(nodes, id) {
        return nodes.filter(node => {
            if (node.id === id) return false;
            if (node.children) {
                node.children = removeNodeFromTree(node.children, id);
            }
            return true;
        });
    }
    
    function toggleCollapse(nodeId) {
        const node = findNode(treeData.nodes, nodeId);
        if (node) {
            node.collapsed = !node.collapsed;
            saveData();
            buildVisualization();
        }
    }
    
    function updateTask(nodeId, data) {
        fetch(`/api/boards/${boardId}/tasks/${nodeId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                loadBoardTasks();
            }
        })
        .catch(console.error);
    }
    
    // Editor functions
    function setDueDate(iso) {
        selectedDate = iso;
        editorDue.dataset.value = iso || '';
        dueDateLabel.textContent = iso ? `üìÖ ${new Date(iso).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'})}` : 'üìÖ Pick deadline‚Ä¶';
    }
    
    function openEditor(nodeId) {
        if (nodeId) {
            const node = findNode(treeData.nodes, nodeId);
            if (!node) return;
            
            editingNodeId = nodeId;
            editorTitle.value = node.title || '';
            editorDesc.value = node.description || '';
            setStartDate(node.start_date || '');
            setEndDate(node.end_date || '');
            document.getElementById('editorEmail').value = node.email || '';
            document.getElementById('editorPhone').value = node.phone || '';
            document.getElementById('editorResponsibility').value = node.responsibility || '';
            editorPriority.value = node.priority || 'medium';
            editorStatus.value = node.status || 'todo';
        } else {
            editingNodeId = null;
            editorTitle.value = '';
            editorDesc.value = '';
            setStartDate('');
            setEndDate('');
            document.getElementById('editorEmail').value = '';
            document.getElementById('editorPhone').value = '';
            document.getElementById('editorResponsibility').value = '';
            editorPriority.value = 'medium';
            editorStatus.value = 'todo';
        }
        
        editor.style.display = 'flex';
        setTimeout(() => {
            editorTitle.focus();
        }, 50);
    }
    
    function setStartDate(iso) {
        document.getElementById('editorStartDate').dataset.value = iso || '';
        document.getElementById('startDateLabel').textContent = iso ? `üìÖ ${new Date(iso).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'})}` : 'üìÖ Pick start date‚Ä¶';
    }
    
    function setEndDate(iso) {
        document.getElementById('editorEndDate').dataset.value = iso || '';
        document.getElementById('endDateLabel').textContent = iso ? `üìÖ ${new Date(iso).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'})}` : 'üìÖ Pick end date‚Ä¶';
    }
    
    function closeEditor() {
        editor.style.display = 'none';
        editingNodeId = null;
        pendingParentId = null;
    }
    
    function saveEditor() {
        if (editingNodeId) {
            const title = editorTitle.value.trim() || 'Untitled Task';
            const description = editorDesc.value.trim();
            const startDate = document.getElementById('editorStartDate').dataset.value;
            const endDate = document.getElementById('editorEndDate').dataset.value;
            const email = document.getElementById('editorEmail').value.trim();
            const phone = document.getElementById('editorPhone').value.trim();
            const responsibility = document.getElementById('editorResponsibility').value.trim();
            const priority = editorPriority.value;
            const status = editorStatus.value;
            
            updateTask(editingNodeId, { title, description, start_date: startDate, end_date: endDate, email, phone, responsibility, priority, status });
            closeEditor();
        } else {
            createChildTask();
        }
    }
    
    // D3 visualization
    function buildVisualization() {
        svg.selectAll('*').remove();
        updateStats();
        
        if (treeData.nodes.length === 0) {
            return;
        }
        
        const width = stage.clientWidth;
        const height = stage.clientHeight;
        
        // Define gradients
        const defs = svg.append('defs');
        
        const gradients = [
            { id: 'gradientTodo', colors: ['#f3f4f6', '#e5e7eb'] },
            { id: 'gradientProgress', colors: ['#fef3c7', '#fde68a'] },
            { id: 'gradientReview', colors: ['#dbeafe', '#bfdbfe'] },
            { id: 'gradientDone', colors: ['#d1fae5', '#a7f3d0'] }
        ];
        
        gradients.forEach(grad => {
            const gradient = defs.append('linearGradient')
                .attr('id', grad.id)
                .attr('x1', '0%').attr('y1', '0%')
                .attr('x2', '0%').attr('y2', '100%');
            
            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', grad.colors[0]);
            
            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', grad.colors[1]);
        });
        
        // Create zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.3, 3])
            .on('zoom', (event) => {
                svg.select('.tree-group').attr('transform', event.transform);
            });
        
        svg.call(zoom);
        
        const treeGroup = svg.append('g').attr('class', 'tree-group');
        
        // Process each root node
        treeData.nodes.forEach((rootNode, index) => {
            const hierarchy = d3.hierarchy(rootNode, d => d.collapsed ? [] : d.children);
            
            let treeLayout;
            if (currentLayout === 'cluster') {
                treeLayout = d3.cluster().size([height - 100, width - 200]);
            } else if (currentLayout === 'radial') {
                treeLayout = d3.tree()
                    .size([2 * Math.PI, Math.min(width, height) / 2 - 200])
                    .separation((a, b) => (a.parent == b.parent ? 3 : 5) / Math.max(a.depth, 1));
            } else {
                treeLayout = d3.tree().size([height - 100, width - 200]);
            }
            
            treeLayout(hierarchy);
            
            // Adjust positions for multiple roots
            const offsetX = currentLayout === 'radial' ? width / 2 : 100;
            const offsetY = currentLayout === 'radial' ? height / 2 : 50 + index * (height / treeData.nodes.length);
            
            hierarchy.descendants().forEach(d => {
                if (currentLayout === 'radial') {
                    const angle = d.x;
                    const radius = d.y + (d.depth * 80);
                    d.x = offsetX + radius * Math.cos(angle - Math.PI / 2);
                    d.y = offsetY + radius * Math.sin(angle - Math.PI / 2);
                } else {
                    const tempX = d.x;
                    d.x = d.y + offsetX;
                    d.y = tempX + offsetY;
                }
            });
            
            renderTree(treeGroup, hierarchy);
        });
        
        updateStats();
    }
    
    function renderTree(container, hierarchy) {
        // Render links
        const links = hierarchy.links();
        
        container.selectAll('.tree-link')
            .data(links, d => d.target.data.id)
            .join('path')
            .attr('class', d => `tree-link status-${d.target.data.status}`)
            .attr('d', d => {
                return `M${d.source.x},${d.source.y}C${d.source.x},${(d.source.y + d.target.y) / 2} ${d.target.x},${(d.source.y + d.target.y) / 2} ${d.target.x},${d.target.y}`;
            });
        
        // Render nodes
        const nodes = hierarchy.descendants();
        
        const nodeGroups = container.selectAll('.tree-node')
            .data(nodes, d => d.data.id)
            .join('g')
            .attr('class', 'tree-node')
            .attr('data-id', d => d.data.id)
            .attr('transform', d => `translate(${d.x},${d.y})`);
        
        // Modern task cards with gradient and shadow effect
        nodeGroups.selectAll('.task-card').remove();
        const cardWidth = 280;
        const cardHeight = 120;
        
        // Card shadow
        nodeGroups.append('rect')
            .attr('class', 'task-shadow')
            .attr('width', cardWidth)
            .attr('height', cardHeight)
            .attr('x', -cardWidth/2 + 3)
            .attr('y', -cardHeight/2 + 3)
            .attr('rx', 16)
            .attr('fill', 'rgba(0,0,0,0.2)')
            .attr('opacity', 0.3);
        
        // Main card
        nodeGroups.append('rect')
            .attr('class', d => `task-card status-${d.data.status} priority-${d.data.priority}`)
            .attr('width', cardWidth)
            .attr('height', cardHeight)
            .attr('x', -cardWidth/2)
            .attr('y', -cardHeight/2)
            .attr('rx', 16)
            .attr('fill', d => {
                const colors = {
                    todo: 'url(#gradientTodo)',
                    progress: 'url(#gradientProgress)', 
                    review: 'url(#gradientReview)',
                    done: 'url(#gradientDone)'
                };
                return colors[d.data.status] || colors.todo;
            })
            .attr('stroke', d => {
                const colors = { low: '#22c55e', medium: '#f59e0b', high: '#ef4444', critical: '#dc2626' };
                return colors[d.data.priority] || '#6b7280';
            })
            .attr('stroke-width', 2);
        
        // Status badge
        nodeGroups.selectAll('.status-badge').remove();
        nodeGroups.append('rect')
            .attr('class', 'status-badge')
            .attr('x', -cardWidth/2 + 10)
            .attr('y', -cardHeight/2 + 10)
            .attr('width', 80)
            .attr('height', 20)
            .attr('rx', 10)
            .attr('fill', d => {
                const colors = { todo: '#6b7280', progress: '#f59e0b', review: '#5b8cff', done: '#22c55e' };
                return colors[d.data.status] || '#6b7280';
            })
            .style('cursor', 'pointer')
            .on('click', function(event, d) {
                event.stopPropagation();
                const statuses = ['todo', 'progress', 'review', 'done'];
                const currentIndex = statuses.indexOf(d.data.status);
                const newStatus = statuses[(currentIndex + 1) % statuses.length];
                updateTask(d.data.id, { status: newStatus });
            });
        
        nodeGroups.append('text')
            .attr('x', -cardWidth/2 + 50)
            .attr('y', -cardHeight/2 + 22)
            .attr('text-anchor', 'middle')
            .attr('fill', 'white')
            .attr('font-size', '10px')
            .attr('font-weight', 'bold')
            .style('pointer-events', 'none')
            .text(d => {
                const labels = { todo: 'TO DO', progress: 'DOING', review: 'REVIEW', done: 'DONE' };
                return labels[d.data.status] || 'TO DO';
            });
        
        // Priority emojis
        nodeGroups.selectAll('.priority-emoji').remove();
        nodeGroups.append('text')
            .attr('class', 'priority-emoji')
            .attr('x', -90)
            .attr('y', -10)
            .attr('font-size', '14px')
            .text(d => {
                const priorityEmojis = { low: 'üü¢', medium: 'üü°', high: 'üî¥', critical: 'üö®' };
                return priorityEmojis[d.data.priority] || 'üü°';
            });
        
        // Task number badge
        nodeGroups.append('circle')
            .attr('cx', cardWidth/2 - 25)
            .attr('cy', -cardHeight/2 + 25)
            .attr('r', 15)
            .attr('fill', '#5b8cff')
            .attr('stroke', '#4f46e5')
            .attr('stroke-width', 2);
        
        nodeGroups.append('text')
            .attr('x', cardWidth/2 - 25)
            .attr('y', -cardHeight/2 + 30)
            .attr('text-anchor', 'middle')
            .attr('fill', 'white')
            .attr('font-size', '10px')
            .attr('font-weight', 'bold')
            .text(d => d.data.task_number || '1');
        
        // Task title (clipped to card bounds)
        nodeGroups.append('text')
            .attr('class', 'task-title')
            .attr('x', -cardWidth/2 + 15)
            .attr('y', -cardHeight/2 + 50)
            .attr('fill', '#1f2937')
            .attr('font-size', '14px')
            .attr('font-weight', 'bold')
            .text(d => {
                const title = d.data.title || 'Untitled Task';
                return title.length > 22 ? title.substring(0, 22) + '...' : title;
            })
            .on('dblclick', (event, d) => openEditor(d.data.id));
        
        // Task description (clipped to card bounds)
        nodeGroups.append('text')
            .attr('class', 'task-desc')
            .attr('x', -cardWidth/2 + 15)
            .attr('y', -cardHeight/2 + 70)
            .attr('fill', '#4b5563')
            .attr('font-size', '11px')
            .text(d => {
                if (!d.data.description) return 'No description';
                const maxLength = 25;
                return d.data.description.length > maxLength ? d.data.description.substring(0, 25) + '...' : d.data.description;
            });
        
        // Responsibility
        nodeGroups.append('text')
            .attr('x', -cardWidth/2 + 15)
            .attr('y', -cardHeight/2 + 85)
            .attr('fill', '#6b7280')
            .attr('font-size', '9px')
            .text(d => {
                if (!d.data.responsibility) return '';
                const resp = d.data.responsibility.length > 15 ? d.data.responsibility.substring(0, 15) + '...' : d.data.responsibility;
                return `üë§ ${resp}`;
            });
        
        // Date range
        nodeGroups.append('text')
            .attr('x', -cardWidth/2 + 15)
            .attr('y', cardHeight/2 - 25)
            .attr('fill', '#6b7280')
            .attr('font-size', '9px')
            .text(d => {
                const start = d.data.start_date ? new Date(d.data.start_date).toLocaleDateString() : '';
                const end = d.data.end_date ? new Date(d.data.end_date).toLocaleDateString() : '';
                if (start && end) return `üìÖ ${start} ‚Üí ${end}`;
                if (end) return `üìÖ Due: ${end}`;
                return '';
            });
        
        // Contact info
        nodeGroups.append('text')
            .attr('x', -cardWidth/2 + 15)
            .attr('y', cardHeight/2 - 10)
            .attr('fill', '#6b7280')
            .attr('font-size', '9px')
            .text(d => {
                if (d.data.email) {
                    const email = d.data.email.length > 12 ? d.data.email.substring(0, 12) + '...' : d.data.email;
                    return `üìß ${email}`;
                }
                if (d.data.phone) {
                    const phone = d.data.phone.length > 12 ? d.data.phone.substring(0, 12) + '...' : d.data.phone;
                    return `üì± ${phone}`;
                }
                return '';
            });
        
        // Action buttons inside card
        const actionButtons = nodeGroups.append('g')
            .attr('class', 'action-buttons')
            .attr('transform', `translate(${cardWidth/2 - 25}, -20)`);
        
        // Add button
        actionButtons.append('rect')
            .attr('x', -8)
            .attr('y', -8)
            .attr('width', 16)
            .attr('height', 16)
            .attr('rx', 4)
            .attr('fill', '#22c55e')
            .style('cursor', 'pointer')
            .on('click', function(event, d) {
                event.stopPropagation();
                addChildTask(d.data.id);
            });
        
        actionButtons.append('text')
            .attr('x', 0)
            .attr('y', 2)
            .attr('text-anchor', 'middle')
            .attr('fill', 'white')
            .attr('font-size', '10px')
            .attr('font-weight', 'bold')
            .style('pointer-events', 'none')
            .text('+');
        
        // Edit button
        actionButtons.append('rect')
            .attr('x', -8)
            .attr('y', 12)
            .attr('width', 16)
            .attr('height', 16)
            .attr('rx', 4)
            .attr('fill', '#5b8cff')
            .style('cursor', 'pointer')
            .on('click', function(event, d) {
                event.stopPropagation();
                openEditor(d.data.id);
            });
        
        actionButtons.append('text')
            .attr('x', 0)
            .attr('y', 22)
            .attr('text-anchor', 'middle')
            .attr('fill', 'white')
            .attr('font-size', '8px')
            .style('pointer-events', 'none')
            .text('‚úé');
        
        // Delete button
        actionButtons.append('rect')
            .attr('x', -8)
            .attr('y', 32)
            .attr('width', 16)
            .attr('height', 16)
            .attr('rx', 4)
            .attr('fill', '#ef4444')
            .style('cursor', 'pointer')
            .on('click', function(event, d) {
                event.stopPropagation();
                deleteTask(d.data.id);
            });
        
        actionButtons.append('text')
            .attr('x', 0)
            .attr('y', 42)
            .attr('text-anchor', 'middle')
            .attr('fill', 'white')
            .attr('font-size', '8px')
            .style('pointer-events', 'none')
            .text('√ó');
        
        // Collapse/expand button for nodes with children
        nodeGroups.filter(d => d.data.children && d.data.children.length > 0)
            .append('g')
            .attr('class', 'collapse-btn-group')
            .attr('transform', `translate(${cardWidth/2 + 15}, 0)`)
            .style('cursor', 'pointer')
            .on('click', function(event, d) {
                event.stopPropagation();
                toggleCollapse(d.data.id);
            })
            .each(function(d) {
                const group = d3.select(this);
                
                group.append('circle')
                    .attr('r', 10)
                    .attr('fill', '#8b5cf6')
                    .attr('stroke', '#7c3aed')
                    .attr('stroke-width', 2);
                
                group.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'white')
                    .attr('font-size', '10px')
                    .attr('font-weight', 'bold')
                    .attr('y', 3)
                    .text(d.data.collapsed ? '+' : '‚àí');
            });
    }
    
    // Search functionality
    function performSearch() {
        const query = searchInput.value.toLowerCase().trim();
        
        svg.selectAll('.tree-node')
            .classed('dim', function(d) {
                if (!query) return false;
                return !d.data.title.toLowerCase().includes(query) && 
                       !d.data.desc.toLowerCase().includes(query);
            });
    }
    
    // Event listeners
    addRootBtn.addEventListener('click', addRootTask);
    emptyAddBtn.addEventListener('click', addRootTask);
    
    editorClose.addEventListener('click', closeEditor);
    editorCancel.addEventListener('click', closeEditor);
    editorSave.addEventListener('click', saveEditor);
    
    editor.addEventListener('click', (e) => {
        if (e.target === editor) closeEditor();
    });
    
    searchInput.addEventListener('input', performSearch);
    
    // Layout change handler
    document.querySelectorAll('input[name="layout"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentLayout = e.target.value;
            buildVisualization();
        });
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && editor.style.display === 'flex') {
            closeEditor();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && editor.style.display === 'flex') {
            saveEditor();
        }
    });
    
    // Window resize handler
    window.addEventListener('resize', () => {
        setTimeout(buildVisualization, 100);
    });
    

    
    // Calendar functions
    function drawCalendar() {
        calGrid.innerHTML = '';
        weekdays.forEach(wd => {
            const div = document.createElement('div');
            div.className = 'cal-wd';
            div.textContent = wd;
            calGrid.appendChild(div);
        });
        
        const firstDay = new Date(viewYear, viewMonth, 1);
        const startDay = (firstDay.getDay() + 6) % 7;
        const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
        
        calTitle.textContent = firstDay.toLocaleString('en-GB', {month: 'long', year: 'numeric'});
        
        for (let i = 0; i < startDay; i++) {
            const div = document.createElement('div');
            div.className = 'cal-day out';
            calGrid.appendChild(div);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
            const iso = new Date(viewYear, viewMonth, day).toISOString().split('T')[0];
            const div = document.createElement('div');
            div.className = 'cal-day';
            div.textContent = day;
            if (iso === selectedDate) div.classList.add('sel');
            div.onclick = () => {
                selectedDate = iso;
                drawCalendar();
            };
            calGrid.appendChild(div);
        }
    }
    
    let currentDateField = null;
    
    // Calendar event listeners
    document.getElementById('editorStartDate').addEventListener('click', () => {
        currentDateField = 'start';
        const currentValue = document.getElementById('editorStartDate').dataset.value;
        if (currentValue) {
            const date = new Date(currentValue);
            viewYear = date.getFullYear();
            viewMonth = date.getMonth();
            selectedDate = currentValue;
        } else {
            const today = new Date();
            viewYear = today.getFullYear();
            viewMonth = today.getMonth();
            selectedDate = null;
        }
        drawCalendar();
        dateModal.style.display = 'flex';
    });
    
    document.getElementById('editorEndDate').addEventListener('click', () => {
        currentDateField = 'end';
        const currentValue = document.getElementById('editorEndDate').dataset.value;
        if (currentValue) {
            const date = new Date(currentValue);
            viewYear = date.getFullYear();
            viewMonth = date.getMonth();
            selectedDate = currentValue;
        } else {
            const today = new Date();
            viewYear = today.getFullYear();
            viewMonth = today.getMonth();
            selectedDate = null;
        }
        drawCalendar();
        dateModal.style.display = 'flex';
    });
    
    document.getElementById('prevM').addEventListener('click', () => {
        viewMonth--;
        if (viewMonth < 0) {
            viewMonth = 11;
            viewYear--;
        }
        drawCalendar();
    });
    
    document.getElementById('nextM').addEventListener('click', () => {
        viewMonth++;
        if (viewMonth > 11) {
            viewMonth = 0;
            viewYear++;
        }
        drawCalendar();
    });
    
    document.getElementById('okBtn').addEventListener('click', () => {
        const dateValue = selectedDate || new Date().toISOString().split('T')[0];
        if (currentDateField === 'start') {
            setStartDate(dateValue);
        } else if (currentDateField === 'end') {
            setEndDate(dateValue);
        }
        dateModal.style.display = 'none';
    });
    
    document.getElementById('cancelBtn').addEventListener('click', () => {
        dateModal.style.display = 'none';
    });
    
    dateModal.addEventListener('click', (e) => {
        if (e.target === dateModal) dateModal.style.display = 'none';
    });
    
    // Initialize
    buildVisualization();
    
    // Prevent scrolling
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
});
</script>
{% endblock %}