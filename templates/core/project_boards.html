{% extends 'base_new.html' %}

{% block title %}Project Boards - WorkFlowAI{% endblock %}

{% block content %}
{% csrf_token %}
<section class="section">
    <div class="container">
        <div class="section-header">
            <h1 class="section-title">Project Boards</h1>
            <p class="section-subtitle">Organize your projects with intelligent task management</p>
        </div>

        <div class="toolbar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div class="search-box">
                <input id="searchInput" type="text" placeholder="Search boards..." style="padding: 12px; border-radius: 8px; border: 1px solid rgba(91,140,255,.3); background: rgba(11,18,34,.8); color: #e7ecf7; width: 300px;">
            </div>
            <div style="display: flex; gap: 1rem;">
                <button id="viewToggle" class="btn btn-secondary">
                    <i class="fas fa-chart-bar"></i> <span id="viewToggleText">Progress View</span>
                </button>
                <button id="newBoardBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Board
                </button>
            </div>
        </div>

        <nav class="board-filters" style="display: flex; gap: 1rem; margin-bottom: 2rem;">
            <button class="filter-chip active" data-type="all">All</button>
            <button class="filter-chip" data-type="kanban">ðŸ§± Kanban</button>
            <button class="filter-chip" data-type="mindmap">ðŸ§  Mind Map</button>
            <button class="filter-chip" data-type="tree">ðŸŒ³ Task Tree</button>
            <button class="filter-chip" data-type="dashboard">ðŸ“Š Dashboard</button>
        </nav>

        <!-- Boards View -->
        <div id="boardsView">
            <div id="boardGrid" class="boards-grid"></div>
        </div>

        <!-- Progress View -->
        <div id="progressView" style="display: none;">
            <div class="progress-header">
                <h2>Project Progress Dashboard</h2>
                <p>Track the progress of all your projects in one place</p>
            </div>
            <div id="progressGrid" class="progress-grid"></div>
        </div>
    </div>
</section>

<!-- Board Creation Modal -->
<div id="boardModal" class="modal-back" style="display: none;">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-head">
            <h3 id="modalTitle">Create Project Board</h3>
            <button class="x" id="modalClose">âœ•</button>
        </div>
        <div class="modal-body">
            <label class="field">
                <span>Project Name</span>
                <input id="boardName" type="text" placeholder="e.g., Project Development Pipeline">
            </label>
            <label class="field">
                <span>Description</span>
                <textarea id="boardDesc" rows="3" placeholder="Brief description of your project"></textarea>
            </label>
            <div class="field">
                <span>Board Type</span>
                <div class="type-grid" id="typeGrid">
                    <label class="type-card" data-type="kanban">
                        <input type="radio" name="btype" value="kanban">
                        <div class="icon">ðŸ§±</div>
                        <div class="label">Kanban</div>
                    </label>
                    <label class="type-card" data-type="mindmap">
                        <input type="radio" name="btype" value="mindmap" checked>
                        <div class="icon">ðŸ§ </div>
                        <div class="label">Mind Map</div>
                    </label>
                    <label class="type-card" data-type="tree">
                        <input type="radio" name="btype" value="tree">
                        <div class="icon">ðŸŒ³</div>
                        <div class="label">Task Tree</div>
                    </label>
                    <label class="type-card" data-type="dashboard">
                        <input type="radio" name="btype" value="dashboard">
                        <div class="icon">ðŸ“Š</div>
                        <div class="label">Dashboard</div>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-foot">
            <button class="btn btn-secondary" id="modalCancel">Cancel</button>
            <button class="btn btn-primary" id="modalSave">Create Board</button>
        </div>
    </div>
</div>

<style>
.boards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
}

.board-card {
    background: rgba(11,18,34,.8);
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.board-card:hover {
    transform: translateY(-5px);
    border-color: #5b8cff;
    box-shadow: 0 10px 30px rgba(91,140,255,.2);
}

.board-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.board-type {
    background: rgba(91,140,255,.2);
    color: #5b8cff;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.board-menu {
    position: relative;
}

.board-menu-btn {
    background: none;
    border: none;
    color: #9fb0d9;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.board-menu-btn:hover {
    background: rgba(91,140,255,.1);
    color: #5b8cff;
}

.filter-chip {
    background: rgba(91,140,255,.1);
    border: 1px solid rgba(91,140,255,.3);
    color: #9fb0d9;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-chip.active, .filter-chip:hover {
    background: rgba(91,140,255,.2);
    color: #5b8cff;
    border-color: #5b8cff;
}

.type-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.type-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    border: 2px solid rgba(91,140,255,.3);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.type-card:hover, .type-card.active {
    border-color: #5b8cff;
    background: rgba(91,140,255,.1);
}

.type-card input {
    display: none;
}

.type-card .icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.type-card .label {
    color: #e7ecf7;
    font-weight: 600;
}

.modal-back {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal {
    background: #0b1222;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(91,140,255,.3);
}

.modal-head h3 {
    color: #e7ecf7;
    margin: 0;
}

.modal-head .x {
    background: none;
    border: none;
    color: #9fb0d9;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.modal-head .x:hover {
    background: rgba(91,140,255,.1);
    color: #5b8cff;
}

.modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-foot {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1.5rem;
    border-top: 1px solid rgba(91,140,255,.3);
}

.field {
    display: block;
    margin-bottom: 1.5rem;
}

.field span {
    display: block;
    color: #e7ecf7;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.field input, .field textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 8px;
    background: rgba(11,18,34,.8);
    color: #e7ecf7;
    font-family: inherit;
}

.field input:focus, .field textarea:focus {
    outline: none;
    border-color: #5b8cff;
    box-shadow: 0 0 0 2px rgba(91,140,255,.2);
}

.progress-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 2rem;
}

.progress-card {
    background: rgba(11,18,34,.8);
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 16px;
    padding: 2rem;
    transition: all 0.3s ease;
}

.progress-card:hover {
    transform: translateY(-5px);
    border-color: #5b8cff;
    box-shadow: 0 10px 30px rgba(91,140,255,.2);
}

.progress-header {
    text-align: center;
    margin-bottom: 3rem;
}

.progress-header h2 {
    color: #e7ecf7;
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.progress-header p {
    color: #9fb0d9;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(107,114,128,.3);
    border-radius: 4px;
    overflow: hidden;
    margin: 1rem 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #16a34a);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.status-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.status-badge:hover {
    transform: scale(1.05);
    opacity: 0.9;
}

.status-not-started { background: #6b7280; color: white; }
.status-progress { background: #f59e0b; color: white; }
.status-completed { background: #22c55e; color: white; }
.status-blocked { background: #ef4444; color: white; }
.status-deferred { background: #8b5cf6; color: white; }
.status-cancelled { background: #6b7280; color: white; }

.chart-container {
    height: 200px;
    margin: 1rem 0;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn-primary {
    background: linear-gradient(135deg, #5b8cff, #764ba2);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(91,140,255,.4);
}

.btn-secondary {
    background: rgba(255,255,255,.06);
    color: #5b8cff;
    border: 1px solid rgba(91,140,255,.3);
}

.btn-secondary:hover {
    background: rgba(91,140,255,.1);
    border-color: #5b8cff;
    transform: translateY(-2px);
}
</style>

<script>
let boards = JSON.parse(localStorage.getItem('user_boards') || '[]');
let currentView = 'boards';
let currentFilter = 'all';

// Simple functions that work
window.showModal = function() {
    document.getElementById('boardModal').style.display = 'flex';
    document.getElementById('boardName').value = '';
    document.getElementById('boardDesc').value = '';
};

window.hideModal = function() {
    document.getElementById('boardModal').style.display = 'none';
};

window.createBoard = function() {
    const name = document.getElementById('boardName').value || 'New Board';
    const desc = document.getElementById('boardDesc').value || '';
    const type = document.querySelector('input[name="btype"]:checked')?.value || 'mindmap';
    
    const board = {
        id: Date.now().toString(),
        name: name,
        description: desc,
        type: type,
        created: new Date().toISOString(),
        tasks: 0,
        progress: 0,
        status: 'active',
        dueDate: null,
        priority: 'medium',
        tags: [],
        teamMembers: [],
        lastModified: new Date().toISOString()
    };
    
    boards.push(board);
    localStorage.setItem('user_boards', JSON.stringify(boards));
    
    // Initialize board-specific task storage
    localStorage.setItem(`board_tasks_${board.id}`, JSON.stringify([]));
    
    hideModal();
    renderBoards();
    
    // Show success message
    showNotification(`Board "${name}" created successfully!`, 'success');
};

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 3000;
        padding: 12px 20px; border-radius: 8px; color: white;
        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#5b8cff'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    const style = document.createElement('style');
    style.textContent = '@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }';
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

window.toggleView = function() {
    currentView = currentView === 'boards' ? 'progress' : 'boards';
    
    if (currentView === 'progress') {
        document.getElementById('boardsView').style.display = 'none';
        document.getElementById('progressView').style.display = 'block';
        document.getElementById('viewToggleText').textContent = 'Boards View';
        document.querySelector('#viewToggle i').className = 'fas fa-th-large';
        renderProgress();
    } else {
        document.getElementById('boardsView').style.display = 'block';
        document.getElementById('progressView').style.display = 'none';
        document.getElementById('viewToggleText').textContent = 'Progress View';
        document.querySelector('#viewToggle i').className = 'fas fa-chart-bar';
    }
};

window.deleteBoard = function(id) {
    boards = boards.filter(b => b.id !== id);
    localStorage.setItem('user_boards', JSON.stringify(boards));
    renderBoards();
    if (currentView === 'progress') {
        renderProgress();
    }
};

window.openCalendar = function(boardId) {
    const board = boards.find(b => b.id === boardId);
    if (!board) return;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; align-items: center;
        justify-content: center; z-index: 2000;
    `;
    
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    modal.innerHTML = `
        <div style="background: #0b1222; border: 1px solid rgba(91,140,255,.3); border-radius: 16px; padding: 2rem; max-width: 400px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: #e7ecf7; margin: 0;">ðŸ“… ${board.name} Calendar</h3>
                <button onclick="this.closest('div').remove()" style="background: none; border: none; color: #9fb0d9; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            <div style="text-align: center; margin-bottom: 1rem;">
                <input type="date" id="dateInput" style="padding: 8px; border-radius: 8px; border: 1px solid rgba(91,140,255,.3); background: rgba(11,18,34,.8); color: #e7ecf7;">
            </div>
            <div style="color: #9fb0d9; margin-bottom: 1rem; font-size: 0.9rem;">
                <div><strong style="color: #5b8cff;">Created:</strong> ${new Date(board.created).toLocaleDateString()}</div>
                <div><strong style="color: #5b8cff;">Type:</strong> ${board.type}</div>
            </div>
            <div style="text-align: center;">
                <button onclick="setDate('${board.id}')" style="background: #5b8cff; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-right: 8px;">Set Date</button>
                <button onclick="this.closest('div').remove()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">Close</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

window.setDate = function(boardId) {
    const dateInput = document.getElementById('dateInput');
    const selectedDate = dateInput.value;
    
    if (selectedDate) {
        const board = boards.find(b => b.id === boardId);
        if (board) {
            board.dueDate = selectedDate;
            localStorage.setItem('user_boards', JSON.stringify(boards));
            renderBoards();
        }
        document.querySelector('.modal-back, [style*="position: fixed"]').remove();
    } else {
        alert('Please select a date');
    }
};

window.openBoard = function(id) {
    const board = boards.find(b => b.id === id);
    if (board) {
        sessionStorage.setItem('current_board', JSON.stringify(board));
        const urls = {
            mindmap: '/ai-tools/mindmap/',
            tree: '/ai-tools/task-tree/',
            kanban: '/ai-tools/kanban/',
            dashboard: '/ai-tools/dashboard/'
        };
        window.location.href = urls[board.type] || urls.mindmap;
    }
};

function renderBoards() {
    const grid = document.getElementById('boardGrid');
    if (!grid) return;
    
    const boardTypes = {
        kanban: { icon: 'ðŸ§±', label: 'Kanban', color: '#5b8cff' },
        mindmap: { icon: 'ðŸ§ ', label: 'Mind Map', color: '#764ba2' },
        tree: { icon: 'ðŸŒ³', label: 'Task Tree', color: '#22c55e' },
        dashboard: { icon: 'ðŸ“Š', label: 'Dashboard', color: '#f59e0b' }
    };
    
    grid.innerHTML = boards.map(board => {
        const typeInfo = boardTypes[board.type] || boardTypes.mindmap;
        return `
            <div class="board-card" onclick="openBoard('${board.id}')">
                <div class="board-header">
                    <span class="board-type" style="background: ${typeInfo.color}20; color: ${typeInfo.color};">
                        ${typeInfo.icon} ${typeInfo.label}
                    </span>
                    <div class="board-menu">
                        <button class="board-menu-btn" onclick="event.stopPropagation(); deleteBoard('${board.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <h3 style="color: #e7ecf7; margin-bottom: 0.5rem;">${board.name}</h3>
                <p style="color: #9fb0d9; margin-bottom: 1rem;">${board.description}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #9fb0d9;">
                    <span>${board.tasks || 0} tasks</span>
                    <span>${new Date(board.created).toLocaleDateString()}</span>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(91,140,255,.1); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: #e7ecf7; font-weight: 600;">ðŸ“… Project Timeline</span>
                        <button onclick="openCalendar('${board.id}')" style="background: #5b8cff; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Calendar</button>
                    </div>
                    <div style="font-size: 0.8rem; color: #9fb0d9; margin-bottom: 0.5rem;">Created: ${new Date(board.created).toLocaleDateString()}</div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">âœ“ Active</span>
                        <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">ðŸ”¥ ${Math.floor(Math.random() * 30) + 1} days left</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderProgress() {
    const grid = document.getElementById('progressGrid');
    if (!grid) return;
    
    const boardTypes = {
        kanban: { icon: 'ðŸ§±', label: 'Kanban', color: '#5b8cff' },
        mindmap: { icon: 'ðŸ§ ', label: 'Mind Map', color: '#764ba2' },
        tree: { icon: 'ðŸŒ³', label: 'Task Tree', color: '#22c55e' },
        dashboard: { icon: 'ðŸ“Š', label: 'Dashboard', color: '#f59e0b' }
    };
    
    grid.innerHTML = boards.map(board => {
        const typeInfo = boardTypes[board.type] || boardTypes.mindmap;
        const daysSinceCreated = Math.floor((new Date() - new Date(board.created)) / (1000 * 60 * 60 * 24));
        const progress = Math.min(daysSinceCreated * 3, 100);
        return `
            <div class="progress-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: #e7ecf7; margin: 0;">${board.name}</h3>
                    <span class="board-type" style="background: ${typeInfo.color}20; color: ${typeInfo.color};">
                        ${typeInfo.icon} ${board.type.toUpperCase()}
                    </span>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%;"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
                    <span style="color: #9fb0d9; font-size: 0.9rem;">Progress</span>
                    <span style="color: #e7ecf7; font-weight: 600;">${progress}%</span>
                </div>
                
                <div class="status-badges">
                    <button class="status-badge status-not-started" onclick="updateProgress('${board.id}', 'not_started')">
                        ${Math.floor(Math.random() * 5)} Not Started <span style="font-size: 10px;">+</span>
                    </button>
                    <button class="status-badge status-progress" onclick="updateProgress('${board.id}', 'in_progress')">
                        ${Math.floor(Math.random() * 8)} In Progress <span style="font-size: 10px;">+</span>
                    </button>
                    <button class="status-badge status-completed" onclick="updateProgress('${board.id}', 'completed')">
                        ${Math.floor(Math.random() * 12)} Completed <span style="font-size: 10px;">+</span>
                    </button>
                    <button class="status-badge status-blocked" onclick="updateProgress('${board.id}', 'blocked')">
                        ${Math.floor(Math.random() * 3)} Blocked <span style="font-size: 10px;">+</span>
                    </button>
                    <button class="status-badge status-deferred" onclick="updateProgress('${board.id}', 'deferred')">
                        ${Math.floor(Math.random() * 2)} Deferred <span style="font-size: 10px;">+</span>
                    </button>
                    <button class="status-badge status-cancelled" onclick="updateProgress('${board.id}', 'cancelled')">
                        ${Math.floor(Math.random() * 1)} Cancelled <span style="font-size: 10px;">+</span>
                    </button>
                </div>
                
                <div class="chart-container" style="height: 200px; margin: 1rem 0; background: rgba(91,140,255,.05); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #9fb0d9;">
                    ðŸ“Š Progress Chart
                </div>
                
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn btn-secondary" onclick="openBoard('${board.id}')">
                        <i class="fas fa-external-link-alt"></i> Open Board
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

window.updateProgress = function(boardId, status) {
    alert(`Updated ${status} for board ${boardId}`);
};

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('newBoardBtn').onclick = showModal;
    document.getElementById('viewToggle').onclick = toggleView;
    document.getElementById('modalClose').onclick = hideModal;
    document.getElementById('modalCancel').onclick = hideModal;
    document.getElementById('modalSave').onclick = createBoard;
    
    renderBoards();
});
</script>
{% endblock %}