{% extends 'base_new.html' %}

{% block title %}Task Manager - WorkFlowAI{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div class="section-header">
            <h1 class="section-title">üìù Task Manager</h1>
            <p class="section-subtitle">Organize and track all your tasks efficiently</p>
        </div>

        <div class="task-toolbar">
            <div class="toolbar-left">
                <input id="taskSearch" type="text" placeholder="Search tasks..." class="search-input">
                <select id="statusFilter" class="filter-select">
                    <option value="all">All Status</option>
                    <option value="todo">To Do</option>
                    <option value="progress">In Progress</option>
                    <option value="review">Review</option>
                    <option value="done">Done</option>
                </select>
                <select id="priorityFilter" class="filter-select">
                    <option value="all">All Priority</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="toolbar-right">
                <button id="addTaskBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Task
                </button>
            </div>
        </div>

        <div class="task-views">
            <div class="view-tabs">
                <button class="tab-btn active" data-view="list">üìã List View</button>
                <button class="tab-btn" data-view="kanban">üß± Kanban</button>
                <button class="tab-btn" data-view="calendar">üìÖ Calendar</button>
            </div>

            <div id="listView" class="task-view active">
                <div id="taskList" class="task-list"></div>
            </div>

            <div id="kanbanView" class="task-view">
                <div class="kanban-board">
                    <div class="kanban-column" data-status="todo">
                        <h3>üìã To Do</h3>
                        <div class="task-column" id="todoColumn"></div>
                    </div>
                    <div class="kanban-column" data-status="progress">
                        <h3>‚ö° In Progress</h3>
                        <div class="task-column" id="progressColumn"></div>
                    </div>
                    <div class="kanban-column" data-status="review">
                        <h3>üëÄ Review</h3>
                        <div class="task-column" id="reviewColumn"></div>
                    </div>
                    <div class="kanban-column" data-status="done">
                        <h3>‚úÖ Done</h3>
                        <div class="task-column" id="doneColumn"></div>
                    </div>
                </div>
            </div>

            <div id="calendarView" class="task-view">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="prevMonth" class="btn btn-secondary">‚Üê</button>
                        <h3 id="currentMonth"></h3>
                        <button id="nextMonth" class="btn btn-secondary">‚Üí</button>
                    </div>
                    <div id="calendar" class="calendar-grid"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Task Modal -->
<div id="taskModal" class="modal-back" style="display: none;">
    <div class="modal">
        <div class="modal-head">
            <h3 id="modalTitle">Add New Task</h3>
            <button class="x" id="modalClose">‚úï</button>
        </div>
        <div class="modal-body">
            <label class="field">
                <span>Task Title</span>
                <input id="taskTitle" type="text" placeholder="Enter task title">
            </label>
            <label class="field">
                <span>Description</span>
                <textarea id="taskDesc" rows="3" placeholder="Task description"></textarea>
            </label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <label class="field">
                    <span>Priority</span>
                    <select id="taskPriority">
                        <option value="low">üü¢ Low</option>
                        <option value="medium" selected>üü° Medium</option>
                        <option value="high">üî¥ High</option>
                        <option value="critical">üö® Critical</option>
                    </select>
                </label>
                <label class="field">
                    <span>Status</span>
                    <select id="taskStatus">
                        <option value="todo" selected>üìã To Do</option>
                        <option value="progress">‚ö° In Progress</option>
                        <option value="review">üëÄ Review</option>
                        <option value="done">‚úÖ Done</option>
                    </select>
                </label>
            </div>
            <label class="field">
                <span>Due Date</span>
                <input id="taskDueDate" type="date">
            </label>
            <label class="field">
                <span>Assignee</span>
                <input id="taskAssignee" type="text" placeholder="Assign to...">
            </label>
        </div>
        <div class="modal-foot">
            <button class="btn btn-secondary" id="modalCancel">Cancel</button>
            <button class="btn btn-primary" id="modalSave">Save Task</button>
        </div>
    </div>
</div>

<style>
.task-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    gap: 1rem;
}

.toolbar-left {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.search-input, .filter-select {
    padding: 8px 12px;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 8px;
    background: rgba(11,18,34,.8);
    color: #e7ecf7;
}

.view-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid rgba(91,140,255,.3);
}

.tab-btn {
    background: none;
    border: none;
    color: #9fb0d9;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

.tab-btn.active, .tab-btn:hover {
    color: #5b8cff;
    border-bottom-color: #5b8cff;
}

.task-view {
    display: none;
}

.task-view.active {
    display: block;
}

.task-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.task-item {
    background: rgba(11,18,34,.8);
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.task-item:hover {
    transform: translateY(-2px);
    border-color: #5b8cff;
    box-shadow: 0 8px 25px rgba(91,140,255,.2);
}

.kanban-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
}

.kanban-column {
    background: rgba(11,18,34,.8);
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 12px;
    padding: 1rem;
    min-height: 400px;
}

.kanban-column h3 {
    color: #e7ecf7;
    margin-bottom: 1rem;
    text-align: center;
}

.task-column {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.kanban-task {
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(91,140,255,.2);
    border-radius: 8px;
    padding: 1rem;
    cursor: move;
    transition: all 0.3s ease;
}

.kanban-task:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(91,140,255,.3);
}

.calendar-container {
    background: rgba(11,18,34,.8);
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 12px;
    padding: 1.5rem;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.calendar-header h3 {
    color: #e7ecf7;
    margin: 0;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: rgba(91,140,255,.1);
}

.calendar-day {
    background: rgba(11,18,34,.8);
    padding: 1rem;
    min-height: 80px;
    border: 1px solid rgba(91,140,255,.2);
    color: #e7ecf7;
    font-size: 0.9rem;
}

.calendar-day.other-month {
    opacity: 0.3;
}

.calendar-day.today {
    background: rgba(91,140,255,.2);
    border-color: #5b8cff;
}

.modal-back {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal {
    background: #0b1222;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(91,140,255,.3);
}

.modal-head h3 {
    color: #e7ecf7;
    margin: 0;
}

.modal-head .x {
    background: none;
    border: none;
    color: #9fb0d9;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.modal-head .x:hover {
    background: rgba(91,140,255,.1);
    color: #5b8cff;
}

.modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-foot {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1.5rem;
    border-top: 1px solid rgba(91,140,255,.3);
}

.field {
    display: block;
    margin-bottom: 1.5rem;
}

.field span {
    display: block;
    color: #e7ecf7;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.field input, .field textarea, .field select {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(91,140,255,.3);
    border-radius: 8px;
    background: rgba(11,18,34,.8);
    color: #e7ecf7;
    font-family: inherit;
}

.field input:focus, .field textarea:focus, .field select:focus {
    outline: none;
    border-color: #5b8cff;
    box-shadow: 0 0 0 2px rgba(91,140,255,.2);
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn-primary {
    background: linear-gradient(135deg, #5b8cff, #764ba2);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(91,140,255,.4);
}

.btn-secondary {
    background: rgba(255,255,255,.06);
    color: #5b8cff;
    border: 1px solid rgba(91,140,255,.3);
}

.btn-secondary:hover {
    background: rgba(91,140,255,.1);
    border-color: #5b8cff;
    transform: translateY(-2px);
}
</style>

<script>
let tasks = JSON.parse(localStorage.getItem('user_tasks') || '[]');
let currentView = 'list';
let editingTaskId = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeTaskManager();
});

function initializeTaskManager() {
    // Event listeners
    document.getElementById('addTaskBtn').onclick = () => openTaskModal();
    document.getElementById('modalClose').onclick = closeTaskModal;
    document.getElementById('modalCancel').onclick = closeTaskModal;
    document.getElementById('modalSave').onclick = saveTask;
    
    // View tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchView(btn.dataset.view));
    });
    
    // Filters
    document.getElementById('taskSearch').addEventListener('input', filterTasks);
    document.getElementById('statusFilter').addEventListener('change', filterTasks);
    document.getElementById('priorityFilter').addEventListener('change', filterTasks);
    
    renderTasks();
}

function openTaskModal(taskId = null) {
    editingTaskId = taskId;
    const modal = document.getElementById('taskModal');
    
    if (taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            document.getElementById('modalTitle').textContent = 'Edit Task';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDesc').value = task.description || '';
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskDueDate').value = task.dueDate || '';
            document.getElementById('taskAssignee').value = task.assignee || '';
        }
    } else {
        document.getElementById('modalTitle').textContent = 'Add New Task';
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDesc').value = '';
        document.getElementById('taskPriority').value = 'medium';
        document.getElementById('taskStatus').value = 'todo';
        document.getElementById('taskDueDate').value = '';
        document.getElementById('taskAssignee').value = '';
    }
    
    modal.style.display = 'flex';
}

function closeTaskModal() {
    document.getElementById('taskModal').style.display = 'none';
    editingTaskId = null;
}

function saveTask() {
    const title = document.getElementById('taskTitle').value.trim();
    if (!title) {
        alert('Please enter a task title');
        return;
    }
    
    const taskData = {
        title,
        description: document.getElementById('taskDesc').value.trim(),
        priority: document.getElementById('taskPriority').value,
        status: document.getElementById('taskStatus').value,
        dueDate: document.getElementById('taskDueDate').value,
        assignee: document.getElementById('taskAssignee').value.trim(),
        created: new Date().toISOString(),
        modified: new Date().toISOString()
    };
    
    if (editingTaskId) {
        const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
        if (taskIndex !== -1) {
            tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
        }
    } else {
        taskData.id = Date.now().toString();
        tasks.push(taskData);
    }
    
    localStorage.setItem('user_tasks', JSON.stringify(tasks));
    closeTaskModal();
    renderTasks();
    showNotification(editingTaskId ? 'Task updated!' : 'Task created!', 'success');
}

function deleteTask(taskId) {
    tasks = tasks.filter(t => t.id !== taskId);
    localStorage.setItem('user_tasks', JSON.stringify(tasks));
    renderTasks();
    showNotification('Task deleted!', 'success');
}

function switchView(view) {
    currentView = view;
    
    // Update tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
    });
    
    // Update views
    document.querySelectorAll('.task-view').forEach(viewEl => {
        viewEl.classList.toggle('active', viewEl.id === view + 'View');
    });
    
    renderTasks();
}

function renderTasks() {
    switch(currentView) {
        case 'list':
            renderListView();
            break;
        case 'kanban':
            renderKanbanView();
            break;
        case 'calendar':
            renderCalendarView();
            break;
    }
}

function renderListView() {
    const container = document.getElementById('taskList');
    const filteredTasks = getFilteredTasks();
    
    if (filteredTasks.length === 0) {
        container.innerHTML = '<div class="empty-state" style="text-align: center; color: #9fb0d9; padding: 3rem;">No tasks found. Create your first task!</div>';
        return;
    }
    
    container.innerHTML = filteredTasks.map(task => `
        <div class="task-item" onclick="openTaskModal('${task.id}')">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <h3 style="color: #e7ecf7; margin: 0;">${task.title}</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <span class="priority-badge priority-${task.priority}">${getPriorityIcon(task.priority)}</span>
                    <span class="status-badge status-${task.status}">${getStatusIcon(task.status)}</span>
                    <button onclick="event.stopPropagation(); deleteTask('${task.id}')" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">√ó</button>
                </div>
            </div>
            ${task.description ? `<p style="color: #9fb0d9; margin-bottom: 1rem;">${task.description}</p>` : ''}
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #9fb0d9;">
                <span>${task.assignee ? `üë§ ${task.assignee}` : 'Unassigned'}</span>
                <span>${task.dueDate ? `üìÖ ${new Date(task.dueDate).toLocaleDateString()}` : 'No due date'}</span>
            </div>
        </div>
    `).join('');
}

function renderKanbanView() {
    const columns = {
        todo: document.getElementById('todoColumn'),
        progress: document.getElementById('progressColumn'),
        review: document.getElementById('reviewColumn'),
        done: document.getElementById('doneColumn')
    };
    
    // Clear columns
    Object.values(columns).forEach(col => col.innerHTML = '');
    
    const filteredTasks = getFilteredTasks();
    
    filteredTasks.forEach(task => {
        const column = columns[task.status];
        if (column) {
            const taskEl = document.createElement('div');
            taskEl.className = 'kanban-task';
            taskEl.innerHTML = `
                <h4 style="color: #e7ecf7; margin: 0 0 0.5rem 0;">${task.title}</h4>
                <p style="color: #9fb0d9; margin: 0 0 0.5rem 0; font-size: 0.9rem;">${task.description || 'No description'}</p>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="priority-badge priority-${task.priority}">${getPriorityIcon(task.priority)}</span>
                    <span style="font-size: 0.8rem; color: #9fb0d9;">${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : ''}</span>
                </div>
            `;
            taskEl.onclick = () => openTaskModal(task.id);
            column.appendChild(taskEl);
        }
    });
}

function renderCalendarView() {
    // Simple calendar implementation
    const container = document.getElementById('calendar');
    const today = new Date();
    const currentMonth = document.getElementById('currentMonth');
    
    currentMonth.textContent = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    container.innerHTML = '<div style="text-align: center; color: #9fb0d9; padding: 3rem;">Calendar view coming soon!</div>';
}

function getFilteredTasks() {
    const searchTerm = document.getElementById('taskSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    
    return tasks.filter(task => {
        const matchesSearch = task.title.toLowerCase().includes(searchTerm) || 
                            (task.description && task.description.toLowerCase().includes(searchTerm));
        const matchesStatus = statusFilter === 'all' || task.status === statusFilter;
        const matchesPriority = priorityFilter === 'all' || task.priority === priorityFilter;
        
        return matchesSearch && matchesStatus && matchesPriority;
    });
}

function filterTasks() {
    renderTasks();
}

function getPriorityIcon(priority) {
    const icons = { low: 'üü¢', medium: 'üü°', high: 'üî¥', critical: 'üö®' };
    return icons[priority] || 'üü°';
}

function getStatusIcon(status) {
    const icons = { todo: 'üìã', progress: '‚ö°', review: 'üëÄ', done: '‚úÖ' };
    return icons[status] || 'üìã';
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 3000;
        padding: 12px 20px; border-radius: 8px; color: white;
        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#5b8cff'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}
</script>
{% endblock %}